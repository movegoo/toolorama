<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tool Cost Dashboard</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ†Ô∏è</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
:root {
  --pink: #FF4F9A;
  --violet: #8B5CF6;
  --yellow: #F6C026;
  --mint: #34D399;
  --blue: #3B82F6;
  --coral: #FF6B6B;
  --orange: #FB923C;
  --bg: #FAF7F5;
  --card: #FFFFFF;
  --text: #1E1B2E;
  --text-light: #6B6580;
  --radius: 20px;
  --shadow: 0 2px 16px rgba(30,27,46,0.07);
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Poppins', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Memphis decorative shapes */
body::before, body::after {
  content: '';
  position: fixed;
  z-index: 0;
  pointer-events: none;
  border-radius: 50%;
}
body::before {
  width: 300px; height: 300px;
  background: radial-gradient(circle, rgba(139,92,246,0.08) 0%, transparent 70%);
  top: -80px; right: -60px;
}
body::after {
  width: 400px; height: 400px;
  background: radial-gradient(circle, rgba(255,79,154,0.06) 0%, transparent 70%);
  bottom: -100px; left: -100px;
}

.memphis-deco {
  position: fixed;
  z-index: 0;
  pointer-events: none;
  opacity: 0.10;
}
.memphis-tri {
  width: 0; height: 0;
  border-left: 40px solid transparent;
  border-right: 40px solid transparent;
  border-bottom: 70px solid var(--yellow);
  top: 180px; left: 40px;
  transform: rotate(15deg);
}
.memphis-circle {
  width: 60px; height: 60px;
  border: 6px solid var(--coral);
  border-radius: 50%;
  top: 400px; right: 60px;
}
.memphis-zigzag {
  top: 650px; left: 30px;
  width: 80px; height: 30px;
  background: repeating-linear-gradient(
    90deg, var(--mint) 0px, var(--mint) 10px, transparent 10px, transparent 20px
  );
  transform: skewY(-8deg);
}
.memphis-cross {
  top: 300px; right: 180px;
  font-size: 60px; font-weight: 900; color: var(--violet);
  line-height: 1;
}
.memphis-dots {
  bottom: 200px; right: 100px;
  width: 80px; height: 80px;
  background: radial-gradient(circle, var(--blue) 3px, transparent 3px);
  background-size: 16px 16px;
}

.container {
  max-width: 1440px;
  margin: 0 auto;
  padding: 32px 40px;
  position: relative;
  z-index: 1;
}

/* Header */
.header {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  margin-bottom: 32px;
  flex-wrap: wrap;
  gap: 16px;
}
.header h1 {
  font-size: 2.4rem;
  font-weight: 900;
  background: linear-gradient(135deg, var(--pink), var(--violet));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  line-height: 1.1;
}
.header-meta {
  display: flex;
  gap: 20px;
  align-items: center;
  flex-wrap: wrap;
}
.header-meta .badge {
  background: var(--card);
  padding: 8px 16px;
  border-radius: 100px;
  font-size: 0.82rem;
  font-weight: 600;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  gap: 6px;
}
.badge .dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  display: inline-block;
}

/* KPI Row */
.kpi-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-bottom: 28px;
}
.kpi-card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 24px 28px;
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
  transition: transform 0.2s, box-shadow 0.2s;
}
.kpi-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 30px rgba(30,27,46,0.12);
}
.kpi-card::after {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 4px;
}
.kpi-card:nth-child(1)::after { background: linear-gradient(90deg, var(--pink), var(--coral)); }
.kpi-card:nth-child(2)::after { background: linear-gradient(90deg, var(--violet), var(--blue)); }
.kpi-card:nth-child(3)::after { background: linear-gradient(90deg, var(--yellow), var(--orange)); }
.kpi-card:nth-child(4)::after { background: linear-gradient(90deg, var(--mint), var(--blue)); }
.kpi-label {
  font-size: 0.78rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-light);
  margin-bottom: 8px;
}
.kpi-value {
  font-size: 2rem;
  font-weight: 800;
  line-height: 1.1;
}
.kpi-sub {
  font-size: 0.75rem;
  color: var(--text-light);
  margin-top: 4px;
}

/* Filter bar */
.filter-bar {
  background: var(--card);
  border-radius: var(--radius);
  padding: 12px 20px;
  box-shadow: var(--shadow);
  margin-bottom: 28px;
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}
.filter-group label {
  display: inline;
  font-size: 0.68rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-light);
  margin-right: 8px;
}
.filter-group {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 0;
}
.chips {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}
.chip {
  padding: 4px 10px;
  border-radius: 100px;
  font-size: 0.7rem;
  font-weight: 600;
  border: 1.5px solid #E5E0EB;
  background: transparent;
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
}
.chip:hover { border-color: var(--violet); }
.chip.active {
  color: #fff;
  border-color: transparent;
}
.chip.active[data-color="pink"] { background: var(--pink); }
.chip.active[data-color="violet"] { background: var(--violet); }
.chip.active[data-color="yellow"] { background: var(--yellow); color: var(--text); }
.chip.active[data-color="mint"] { background: var(--mint); }
.chip.active[data-color="blue"] { background: var(--blue); }
.chip.active[data-color="coral"] { background: var(--coral); }
.chip.active[data-color="orange"] { background: var(--orange); }
.chip.active[data-color="all"] { background: var(--text); }
.filter-reset {
  margin-left: auto;
  padding: 4px 12px;
  border-radius: 100px;
  border: none;
  background: var(--bg);
  font-family: inherit;
  font-size: 0.68rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.15s;
}
.filter-reset:hover { background: #E5E0EB; }

/* Bento Grid */
.bento {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  margin-bottom: 28px;
}
.bento-card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 28px;
  box-shadow: var(--shadow);
  transition: transform 0.2s;
}
.bento-card:hover { transform: translateY(-2px); }
.bento-card h3 {
  font-size: 0.95rem;
  font-weight: 700;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.bento-card h3 .icon {
  width: 28px; height: 28px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}
.chart-wrap {
  position: relative;
  max-width: 260px;
  margin: 0 auto;
}
.chart-center-label {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  pointer-events: none;
}
.chart-center-label .amount {
  font-size: 1.3rem;
  font-weight: 800;
  display: block;
}
.chart-center-label .sub {
  font-size: 0.7rem;
  color: var(--text-light);
}
.legend-list {
  margin-top: 18px;
  list-style: none;
}
.legend-list li {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 5px 0;
  font-size: 0.8rem;
  border-bottom: 1px solid #F3F0F7;
}
.legend-list li:last-child { border: none; }
.legend-dot {
  width: 10px; height: 10px;
  border-radius: 3px;
  display: inline-block;
  margin-right: 8px;
  flex-shrink: 0;
}
.legend-name {
  flex: 1;
  font-weight: 500;
}
.legend-value {
  font-weight: 700;
  white-space: nowrap;
}

/* Span 2 for bar chart */
.bento-wide { grid-column: span 2; }

/* Table Section */
.table-section {
  background: var(--card);
  border-radius: var(--radius);
  padding: 28px;
  box-shadow: var(--shadow);
  margin-bottom: 28px;
}
.table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 12px;
}
.table-header h3 {
  font-size: 0.95rem;
  font-weight: 700;
}
.search-input {
  padding: 8px 16px;
  border-radius: 100px;
  border: 2px solid #E5E0EB;
  font-family: inherit;
  font-size: 0.82rem;
  width: 260px;
  outline: none;
  transition: border-color 0.15s;
}
.search-input:focus { border-color: var(--violet); }

.table-scroll { overflow-x: auto; }
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.82rem;
}
thead th {
  text-align: left;
  padding: 10px 12px;
  font-weight: 700;
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-light);
  border-bottom: 2px solid #F3F0F7;
  cursor: pointer;
  white-space: nowrap;
  user-select: none;
}
thead th:hover { color: var(--violet); }
thead th .sort-arrow { margin-left: 4px; opacity: 0.4; }
thead th.sorted .sort-arrow { opacity: 1; color: var(--violet); }
tbody tr {
  border-bottom: 1px solid #F8F6FA;
  transition: background 0.1s;
}
tbody tr:hover { background: #FAF7FF; }
tbody td {
  padding: 10px 12px;
  white-space: nowrap;
}
.bu-tag {
  display: inline-block;
  padding: 2px 10px;
  border-radius: 100px;
  font-size: 0.7rem;
  font-weight: 600;
}
.bu-ms { background: #FFE4F0; color: #D6336C; }
.bu-farly { background: #EDE4FF; color: #7C3AED; }
.bu-story { background: #FFF7DB; color: #B8860B; }
.bu-widely { background: #D5F5EC; color: #0D9F6E; }

/* Alert Section */
.alert-section {
  background: var(--card);
  border-radius: var(--radius);
  padding: 28px;
  box-shadow: var(--shadow);
  margin-bottom: 28px;
  border-left: 5px solid var(--coral);
}
.alert-section h3 {
  font-size: 0.95rem;
  font-weight: 700;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--coral);
}
.alert-section h3 .icon {
  width: 28px; height: 28px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  background: #FFE4E4;
}
.alert-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
  gap: 16px;
}
.alert-card {
  background: #FFF8F7;
  border-radius: 14px;
  padding: 20px;
  border: 1px solid #FFE0DB;
  transition: transform 0.2s;
}
.alert-card:hover { transform: translateY(-2px); }
.alert-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
  gap: 10px;
}
.alert-card-header .tool-info {
  flex: 1;
}
.alert-card-header .tool-name {
  font-weight: 700;
  font-size: 0.95rem;
}
.alert-card-header .tool-meta {
  font-size: 0.75rem;
  color: var(--text-light);
  margin-top: 2px;
}
.alert-card-header .tool-cost {
  font-weight: 800;
  font-size: 0.95rem;
  white-space: nowrap;
}
.countdown-badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 100px;
  font-size: 0.7rem;
  font-weight: 700;
  margin-bottom: 10px;
}
.countdown-badge.urgent { background: #FFE0E0; color: #DC2626; }
.countdown-badge.warning { background: #FFF3D6; color: #D97706; }
.countdown-badge.soon { background: #FEF9C3; color: #A16207; }
.countdown-badge.overdue { background: #FEE2E2; color: #991B1B; border: 1px dashed #DC2626; }
.alert-verdict {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 100px;
  font-size: 0.7rem;
  font-weight: 700;
  background: #EDE4FF;
  color: #7C3AED;
  margin-bottom: 8px;
}
.alert-reason {
  font-size: 0.78rem;
  color: var(--text-light);
  line-height: 1.5;
  margin-bottom: 12px;
  padding: 10px 14px;
  background: #FAF7F5;
  border-radius: 10px;
  border-left: 3px solid #E5E0EB;
}
.alt-label {
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-light);
  margin-bottom: 6px;
}
.alt-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.alt-item {
  display: flex;
  align-items: baseline;
  gap: 8px;
  font-size: 0.78rem;
}
.alt-tag {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 100px;
  font-size: 0.65rem;
  font-weight: 700;
  white-space: nowrap;
  flex-shrink: 0;
}
.alt-tag.stack { background: #DBEAFE; color: #1E40AF; }
.alt-tag.free { background: #D5F5EC; color: #065F46; }
.alt-tag.synergy { background: #FFF7DB; color: #92400E; }
.alt-tag.alternative { background: #F3F0F7; color: #6B6580; }
.alt-item-name {
  font-weight: 600;
  flex-shrink: 0;
}
.alt-item-detail {
  color: var(--text-light);
  font-size: 0.75rem;
}

/* Footer */
.footer {
  text-align: center;
  padding: 20px;
  font-size: 0.72rem;
  color: var(--text-light);
}

/* Responsive */
@media (max-width: 1024px) {
  .kpi-row { grid-template-columns: repeat(2, 1fr); }
  .bento { grid-template-columns: 1fr; }
  .bento-wide { grid-column: span 1; }
  .alert-cards { grid-template-columns: 1fr; }
}
@media (max-width: 640px) {
  .container { padding: 16px; }
  .kpi-row { grid-template-columns: 1fr; }
  .header h1 { font-size: 1.6rem; }
}
</style>
</head>
<body>

<!-- Memphis decorative shapes -->
<div class="memphis-deco memphis-tri"></div>
<div class="memphis-deco memphis-circle"></div>
<div class="memphis-deco memphis-zigzag"></div>
<div class="memphis-deco memphis-cross">+</div>
<div class="memphis-deco memphis-dots"></div>

<div class="container">
  <!-- Header -->
  <header class="header">
    <div>
      <h1>Tool Cost Dashboard</h1>
      <p style="color:var(--text-light);font-size:0.85rem;margin-top:4px;">Suivi des co√ªts outils SaaS & Tech</p>
    </div>
    <div class="header-meta">
      <div class="badge"><span class="dot" style="background:var(--mint)"></span> 17 f√©vrier 2026</div>
      <div class="badge"><span class="dot" style="background:var(--yellow)"></span> 1 USD = 0.844 EUR</div>
    </div>
  </header>

  <!-- KPIs -->
  <div class="kpi-row" id="kpi-row"></div>

  <!-- Filters -->
  <div class="filter-bar">
    <div class="filter-group">
      <label>BU</label>
      <div class="chips" id="bu-chips"></div>
    </div>
    <span style="width:1px;height:24px;background:#E5E0EB;flex-shrink:0"></span>
    <div class="filter-group">
      <label>√âquipe</label>
      <div class="chips" id="team-chips"></div>
    </div>
    <button class="filter-reset" id="reset-filters">Reset</button>
  </div>

  <!-- Bento Charts -->
  <div class="bento">
    <!-- Donut BU -->
    <div class="bento-card">
      <h3><span class="icon" style="background:#FFE4F0;">üè¢</span> R√©partition par BU</h3>
      <div class="chart-wrap">
        <canvas id="chart-bu"></canvas>
        <div class="chart-center-label">
          <span class="amount" id="bu-center-amount"></span>
          <span class="sub">Total annuel</span>
        </div>
      </div>
      <ul class="legend-list" id="legend-bu"></ul>
    </div>

    <!-- Top 10 tools -->
    <div class="bento-card">
      <h3><span class="icon" style="background:#EDE4FF;">üèÜ</span> Top 10 outils par co√ªt</h3>
      <div class="chart-wrap">
        <canvas id="chart-top10"></canvas>
        <div class="chart-center-label">
          <span class="amount" id="top10-center-amount"></span>
          <span class="sub">Top 10</span>
        </div>
      </div>
      <ul class="legend-list" id="legend-top10"></ul>
    </div>

    <!-- Donut Team -->
    <div class="bento-card">
      <h3><span class="icon" style="background:#D5F5EC;">üë•</span> R√©partition par √©quipe</h3>
      <div class="chart-wrap">
        <canvas id="chart-team"></canvas>
        <div class="chart-center-label">
          <span class="amount" id="team-center-amount"></span>
          <span class="sub">Total</span>
        </div>
      </div>
      <ul class="legend-list" id="legend-team"></ul>
    </div>

    <!-- Bar chart monthly vs yearly -->
    <div class="bento-card bento-wide">
      <h3><span class="icon" style="background:#FFF7DB;">üìä</span> Monthly vs Yearly ‚Äî par BU</h3>
      <div style="max-height:320px;">
        <canvas id="chart-bar"></canvas>
      </div>
    </div>

    <!-- Co√ªt par si√®ge moyen par BU -->
    <div class="bento-card">
      <h3><span class="icon" style="background:#FFE4E4;">üí∫</span> Co√ªt moyen / si√®ge / an</h3>
      <div style="max-height:320px;">
        <canvas id="chart-seat"></canvas>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="table-section">
    <div class="table-header">
      <h3>üìã D√©tail de tous les outils</h3>
      <input type="text" class="search-input" id="search" placeholder="Rechercher un outil...">
    </div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th data-sort="name">Outil <span class="sort-arrow">‚Üï</span></th>
            <th data-sort="team">√âquipe <span class="sort-arrow">‚Üï</span></th>
            <th data-sort="bu">BU <span class="sort-arrow">‚Üï</span></th>
            <th data-sort="renewal">Type <span class="sort-arrow">‚Üï</span></th>
            <th data-sort="seats">Si√®ges <span class="sort-arrow">‚Üï</span></th>
            <th data-sort="pricePerSeat">Prix/si√®ge <span class="sort-arrow">‚Üï</span></th>
            <th data-sort="annualCost">Co√ªt annuel (‚Ç¨) <span class="sort-arrow">‚Üï</span></th>
            <th>Admin</th>
            <th>Lien</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Alertes renouvellement -->
  <div class="alert-section" id="alert-section" style="display:none;">
    <h3><span class="icon">‚ö†Ô∏è</span> Alertes renouvellement ‚Äî Yearly</h3>
    <div class="alert-cards" id="alert-cards"></div>
  </div>

  <footer class="footer">
    Dashboard g√©n√©r√© le 17/02/2026 ‚Äî Donn√©es snapshot Google Sheet ‚Äî Taux USD‚ÜíEUR: 0.844
  </footer>
</div>

<script>
// ==================== DATA ====================
const USD_TO_EUR = 0.844;

// Real data from Google Sheet (snapshot 17/02/2026)
// Entries with "NC", "Je ne connais pas", or unknown pricing are flagged excluded=true
const rawTools = [
  { name: "Miro", team: "Conseil, Tech, Product, Partners", bu: "MS group", price: 8, currency: "USD", renewal: "yearly", seats: 27, renewalDate: "2026-02-16", admin: "chloe.pelletier@mobsuccess.com", url: "https://miro.com/" },
  { name: "Cursor", team: "Tech", bu: "MS group", price: 20, currency: "USD", renewal: "monthly", seats: 1, renewalDate: "2026-02-23", admin: "nicolas.otmani@mobsuccess.com", url: "https://cursor.com/dashboard?tab=billing" },
  { name: "Cursor", team: "Tech", bu: "MS group", price: 24, currency: "USD", renewal: "monthly", seats: 1, renewalDate: "2026-02-23", admin: "nicolas.otmani@mobsuccess.com", url: "https://cursor.com/dashboard?tab=billing", note: "Vincent" },
  { name: "Creatify", team: "Adops", bu: "Farly", price: 39, currency: "EUR", renewal: "monthly", seats: 1, renewalDate: "2026-02-17", admin: "Acquisition@farly.io", url: "https://app.creatify.ai/" },
  { name: "Cursor", team: "Tech", bu: "MS group", price: 60, currency: "USD", renewal: "monthly", seats: 1, renewalDate: "2026-01-03", admin: "nicolas.otmani@mobsuccess.com", url: "https://cursor.com/dashboard?tab=billing", note: "Nicolas" },
  { name: "Copilot", team: "Tech", bu: "MS group", price: 39, currency: "USD", renewal: "monthly", seats: 1, renewalDate: "2026-01-01", admin: "christopher.allene@mobsuccess.com", url: "https://github.com/enterprises/mobsuccess/billing" },
  { name: "Apptweak", team: "Media Buying & UA, Adops", bu: "Farly", price: 249, currency: "USD", renewal: "monthly", seats: 1, renewalDate: "2026-02-02", admin: "acquisition@farly.io", url: "https://app.apptweak.com/" },
  { name: "Notion", team: "All", bu: "MS group", price: 0, currency: "EUR", renewal: "monthly", seats: 174, admin: "chloe.pelletier@mobsuccess.com", url: "https://notion.com/" },
  { name: "Notion (pages publiques)", team: "All", bu: "MS group", price: 23.5, currency: "EUR", renewal: "monthly", seats: 1, renewalDate: "2026-03-06", admin: "chloe.pelletier@mobsuccess.com", url: "https://notion.com/" },
  { name: "Pandadoc", team: "Sales", bu: "Widely", price: 1868, currency: "USD", renewal: "yearly", seats: 1, renewalDate: "2026-07-04", admin: "sales@mobsuccess.com", url: "https://app.pandadoc.com/a/#/settings/billing" },
  { name: "Copilot", team: "Tech", bu: "MS group", price: 21.6, currency: "EUR", renewal: "monthly", seats: 4, admin: "antoine.hinge@mobsuccess.com", url: "https://github.com/" },
  { name: "Copilot", team: "Product", bu: "MS group", price: 10, currency: "USD", renewal: "monthly", seats: 5, admin: "antoine.hinge@mobsuccess.com", url: "https://github.com/" },
  { name: "Pycharm", team: "Tech", bu: "MS group", price: 300, currency: "EUR", renewal: "yearly", seats: 2, admin: "antoine.hinge@mobsuccess.com", url: "https://jetbrains.com/" },
  { name: "DataGrip", team: "Tech", bu: "MS group", price: 259, currency: "EUR", renewal: "yearly", seats: 1, admin: "antoine.hinge@mobsuccess.com", url: "https://jetbrains.com/" },
  { name: "NordVPN", team: "Ops/Products, Publisher, AM", bu: "Farly", price: 195, currency: "USD", renewal: "yearly", seats: 1, renewalDate: "2027-01-29", admin: "acquisition@farly.io", url: "https://nordvpn.com/" },
  { name: "NordPass", team: "Ops/Products, Publisher, AM, Sales", bu: "Farly", price: 83, currency: "USD", renewal: "yearly", seats: 24, renewalDate: "2026-10-28", admin: "individual emails", url: "https://nordpass.com/" },
  { name: "Timetastic", team: "Ops/Products, Publisher, AM, Sales", bu: "Farly", price: 1.5, currency: "USD", renewal: "monthly", seats: 22, admin: "individual emails", url: "https://app.timetastic.co.uk/" },
  { name: "24Metrics", team: "Ops/Products, Publisher, AM, Sales", bu: "Farly", price: 1400, currency: "USD", renewal: "monthly", seats: 1, admin: "rewarded@farly.io", url: "https://www.24metrics.com/" },
  { name: "Docusign", team: "Ops/Products, Publisher, AM, Sales", bu: "Farly", price: 1, currency: "USD", renewal: "yearly", seats: 1, renewalDate: "2026-11-01", admin: "sales@farly.io", url: "https://account.docusign.com/" },
  { name: "Everflow", team: "Ops/Products, Publisher, AM, Sales", bu: "Farly", price: 9500, currency: "USD", renewal: "monthly", seats: 1, admin: "individual emails", url: "https://farly.everflowclient.io/" },
  { name: "Affilitest", team: "Ops/Products, Publisher, AM, Sales", bu: "Farly", price: 99, currency: "USD", renewal: "monthly", seats: 1, admin: "support@farly.io", url: "https://affilitest.com/" },
  { name: "Keyword Tool", team: "Conseil", bu: "Story", price: 190, currency: "EUR", renewal: "yearly", seats: 5, renewalDate: "2027-01-22", admin: "ken.tan@storysuccess.fr", url: "https://keywordtool.io/" },
  { name: "Social Insider", team: "Conseil", bu: "Story", price: 3500, currency: "USD", renewal: "yearly", seats: 5, renewalDate: "2026-02-26", admin: "ken.tan@storysuccess.fr", url: "https://www.socialinsider.io/" },
  { name: "Cursor", team: "Cr√©a - Ad content", bu: "Story", price: 20, currency: "USD", renewal: "monthly", seats: 3, admin: "julie.midon@storysuccess.fr", url: "https://cursor.com/" },
  { name: "Gamma", team: "Partners", bu: "MS group", price: 24, currency: "EUR", renewal: "monthly", seats: 1, renewalDate: "2026-02-28", admin: "romain.girard@mobsuccess.com", url: "https://gamma.app/" },
  { name: "ChatGPT", team: "All", bu: "MS group", price: 30, currency: "USD", renewal: "monthly", seats: 22, renewalDate: "2026-03-30", admin: "ahmat.faki@mobsuccess.com", url: "https://chatgpt.com/" },
  { name: "PhantomBuster", team: "Sales, Marketing", bu: "MS group", price: 69, currency: "USD", renewal: "monthly", seats: 1, renewalDate: "2026-02-25", admin: "jeremy.fort@mobsuccess.com", url: "https://phantombuster.com/" },
  { name: "Scrape Creators", team: "Product, Vid√©o", bu: "MS group", price: 49, currency: "USD", renewal: "monthly", seats: 1, admin: "ahmat.faki@mobsuccess.com", url: "https://app.scrapecreators.com/" },
  { name: "Submagic", team: "Vid√©o", bu: "Story", price: 1104, currency: "EUR", renewal: "yearly", seats: 1, renewalDate: "2026-09-23", admin: "morgane.derrien@storysuccess.fr", url: "https://app.submagic.co/" },
  { name: "Artlist", team: "Vid√©o", bu: "Story", price: 575, currency: "EUR", renewal: "yearly", seats: 1, renewalDate: "2026-02-17", admin: "melissa.abrini@storysuccess.fr", url: "https://artlist.io/" },
  { name: "Envato", team: "Vid√©o", bu: "Story", price: 39, currency: "EUR", renewal: "monthly", seats: 1, renewalDate: "2026-03-01", admin: "vincent.ribe-puig@storysuccess.fr", url: "https://app.envato.com/" },
  { name: "iStock", team: "√âdito", bu: "Story", price: 1758.9, currency: "EUR", renewal: "monthly", seats: 1, renewalDate: "2026-06-17", admin: "quentin.sellier@storysuccess.fr", url: "https://www.istockphoto.com/fr" },
  { name: "Signaturit", team: "RH / Admin", bu: "MS group", price: 330, currency: "EUR", renewal: "yearly", seats: 3, renewalDate: "2026-02-27", admin: "jessica.lessinger@mobsuccess.com", url: "https://www.signaturit.com/" },
  { name: "Screenful", team: "Tech, Product", bu: "MS group", price: 141, currency: "USD", renewal: "monthly", seats: 1, renewalDate: "2026-02-28", admin: "chloe.pelletier@mobsuccess.com", url: "https://app.screenful.me/" },
  { name: "Figma", team: "Cr√©a - digital/Ad content", bu: "Story", price: 20, currency: "EUR", renewal: "monthly", seats: 25, renewalDate: "2026-02-19", admin: "vincent.ribe-puig@storysuccess.fr", url: "https://www.figma.com/" },
  { name: "Overlord 2", team: "Cr√©a - Ad content", bu: "Story", price: 70, currency: "USD", renewal: "yearly", seats: 3, renewalDate: "2026-01-07", admin: "vincent.ribe-puig@storysuccess.fr", url: "https://battleaxe.co/overlord" },
  { name: "Envato Elements", team: "Cr√©a - digital/Ad content", bu: "Story", price: 46.8, currency: "EUR", renewal: "monthly", seats: 1, renewalDate: "2026-02-01", admin: "vincent.ribe-puig@storysuccess.fr", url: "https://app.envato.com/" },
  { name: "Jimo", team: "Product", bu: "MS group", price: 480, currency: "EUR", renewal: "yearly", seats: 15, renewalDate: "2026-07-19", admin: "chloe.pelletier@mobsuccess.com", url: "https://i.usejimo.com/settings/billing" },
  { name: "Figma", team: "Product", bu: "MS group", price: 600, currency: "USD", renewal: "yearly", seats: 6, renewalDate: "2027-01-04", admin: "chloe.pelletier@mobsuccess.com", url: "https://www.figma.com/" },
  { name: "Linear", team: "Tech, Product", bu: "MS group", price: 360, currency: "USD", renewal: "yearly", seats: 39, renewalDate: "2026-11-04", admin: "chloe.pelletier@mobsuccess.com", url: "https://linear.app/" },
  { name: "IntelliJ", team: "Tech", bu: "MS group", price: 240, currency: "EUR", renewal: "yearly", seats: 1, renewalDate: "2027-02-01", admin: "florent.sorel@mobsuccess.com", url: "https://www.jetbrains.com/idea/" },
  { name: "Supermetrics", team: "Media Buying & UA, Conseil", bu: "Story", price: 1596, currency: "EUR", renewal: "yearly", seats: 3, renewalDate: "2026-02-18", admin: "eloah.vanhoucke@storysuccess.fr", url: "https://hub.supermetrics.com/" },
  { name: "Adobe", team: "Cr√©a, Vid√©o", bu: "Story", price: 0, currency: "EUR", renewal: "yearly", seats: 28, excluded: true, note: "Prix enterprise inconnu", admin: "jessica@successfuel.io", url: "https://adminconsole.adobe.com/" },
  { name: "Pitch", team: "All", bu: "MS group", price: 204, currency: "EUR", renewal: "yearly", seats: 82, renewalDate: "2026-01-12", admin: "eloah.vanhoucke@storysuccess.fr", url: "https://app.pitch.com/" },
  { name: "Filestage", team: "Sales, Adops, Conseil, Marketing, Partners, Cr√©a - digital content, Cr√©a - Ad content", bu: "Story", price: 13416, currency: "EUR", renewal: "yearly", seats: 1, renewalDate: "2026-08-28", note: "Prix total, 33 si√®ges", admin: "melissa.abrini@storysuccess.fr", url: "https://filestage.io/" },
  { name: "Claude", team: "Product", bu: "MS group", price: 18, currency: "EUR", renewal: "monthly", seats: 1, renewalDate: "2026-01-31", admin: "alexandre.binjamin@mobsuccess.com", url: "https://claude.ai/" },
  { name: "Yougov", team: "Sales, Adops, Conseil, Marketing, Partners", bu: "MS group", price: 75000, currency: "EUR", renewal: "yearly", seats: 1, note: "Si√®ges illimit√©s, prix total", admin: "nicolas.tarricone@yougov.com", url: "https://platform.yougov.com/" },
  { name: "HubSpot", team: "Sales, Conseil, Finances", bu: "MS group", price: 8205.47, currency: "EUR", renewal: "yearly", seats: 1, renewalDate: "2026-02-28", note: "Prix total", url: "https://www.hubspot.fr/" },
  { name: "ChatGPT (duplicate)", team: "Conseil", bu: "MS group", price: 0, currency: "EUR", renewal: "yearly", seats: 0, excluded: true, note: "NC ‚Äî doublon probable" },
  { name: "Pitch", team: "Conseil", bu: "Widely", price: 0, currency: "EUR", renewal: "yearly", seats: 0, excluded: true, note: "Prix NC" },
  { name: "Sharepoint", team: "Conseil", bu: "Widely", price: 0, currency: "EUR", renewal: "yearly", seats: 0, excluded: true, note: "Prix NC" },
  { name: "Monday", team: "Adops, Conseil", bu: "MS group", price: 0, currency: "EUR", renewal: "yearly", seats: 0, excluded: true, note: "Prix NC" },
  { name: "Apollo.io", team: "Sales", bu: "Farly", price: 0, currency: "EUR", renewal: "monthly", seats: 1, admin: "samira.latoui@mobsuccess.com", url: "https://app.apollo.io/" },
  { name: "Crowdin", team: "Product", bu: "MS group", price: 1595, currency: "EUR", renewal: "yearly", seats: 1, renewalDate: "2026-10-01", admin: "philippe.auriach@mobsuccess.com", url: "https://crowdin.com/" },
  { name: "Pennylane", team: "Finances", bu: "MS group", price: 12000, currency: "EUR", renewal: "yearly", seats: 1, renewalDate: "2026-02-28", admin: "clement.nogues@mobsuccess.com", url: "https://app.pennylane.com/" },
  { name: "LinkedIn Sales Nav", team: "Sales", bu: "MS group", price: 13000, currency: "EUR", renewal: "yearly", seats: 1, renewalDate: "2026-10-31", admin: "xavier.dupont@mobsuccess.com", url: "https://business.linkedin.com/sales-solutions/sales-navigator" },
  { name: "Monday", team: "All", bu: "Story", price: 192, currency: "USD", renewal: "yearly", seats: 87, renewalDate: "2027-12-05", admin: "ken.tan@storysuccess.fr", url: "https://storysuccess.monday.com/" },
  { name: "Crisp", team: "Tech, Product", bu: "Story", price: 95, currency: "EUR", renewal: "monthly", seats: 1, renewalDate: "2026-03-01", admin: "chloe.pelletier@mobsuccess.com", url: "https://app.crisp.chat/" },
  { name: "Quicksight", team: "Adops", bu: "Widely", price: 0, currency: "EUR", renewal: "yearly", seats: 16, excluded: true, note: "Prix inconnu", admin: "olivier.ta@mobsuccess.com", url: "https://eu-central-1.quicksight.aws.amazon.com/" },
  { name: "Monday", team: "Adops", bu: "Widely", price: 19, currency: "EUR", renewal: "monthly", seats: 16, admin: "yannis.echchelh@mobsuccess.com", url: "https://storysuccess.monday.com/" },
  { name: "ChatGPT", team: "Adops", bu: "Widely", price: 0, currency: "EUR", renewal: "monthly", seats: 16, excluded: true, note: "Prix inconnu", admin: "olivier.ta@mobsuccess.com", url: "https://chatgpt.com/" },
  { name: "Filestage", team: "Adops", bu: "Widely", price: 0, currency: "EUR", renewal: "monthly", seats: 16, excluded: true, note: "Prix inconnu" },
  { name: "Microsoft Office", team: "Adops", bu: "Widely", price: 0, currency: "EUR", renewal: "yearly", seats: 16, excluded: true, note: "Prix inconnu", admin: "olivier.ta@mobsuccess.com" },
  { name: "Notion", team: "Adops", bu: "Widely", price: 0, currency: "EUR", renewal: "yearly", seats: 16, excluded: true, note: "Prix inconnu", admin: "olivier.ta@mobsuccess.com" },
];

// ==================== COMPUTE ====================
function computeAnnualCostEUR(t) {
  let cost;
  if (t.renewal === 'monthly') {
    cost = t.seats * t.price * 12;
  } else if (t.renewal === 'quarterly') {
    cost = t.seats * t.price * 4;
  } else {
    cost = t.seats * t.price;
  }
  if (t.currency === 'USD') cost *= USD_TO_EUR;
  return Math.round(cost);
}

// Split multi-team entries into primary team (first listed)
function primaryTeam(t) {
  const raw = t.team;
  if (raw === 'All') return 'All';
  return raw.split(',')[0].trim();
}

const tools = rawTools
  .filter(t => !t.excluded && t.price > 0) // Exclude NC/unknown and free tools
  .map(t => ({
    ...t,
    annualCost: computeAnnualCostEUR(t),
    pricePerSeat: t.price,
    primaryTeam: primaryTeam(t)
  }));

// Also keep excluded items for display in table (greyed out)
const allToolsForTable = rawTools.map(t => ({
  ...t,
  annualCost: t.excluded ? 0 : computeAnnualCostEUR(t),
  pricePerSeat: t.price,
  primaryTeam: primaryTeam(t)
}));

const BU_LIST = ["MS group", "Farly", "Story", "Widely"];
const TEAM_LIST = [...new Set(tools.map(t => t.primaryTeam))].sort();

const BU_COLORS = {
  "MS group": "#FF4F9A",
  "Farly": "#8B5CF6",
  "Story": "#F6C026",
  "Widely": "#34D399"
};

const TEAM_COLORS_LIST = ["#FF4F9A","#8B5CF6","#F6C026","#34D399","#3B82F6","#FF6B6B","#FB923C","#06B6D4","#A78BFA","#F472B6","#FBBF24","#4ADE80"];
const TEAM_COLORS = {};
TEAM_LIST.forEach((t, i) => { TEAM_COLORS[t] = TEAM_COLORS_LIST[i % TEAM_COLORS_LIST.length]; });

const CHIP_COLORS_BU = { "MS group": "pink", "Farly": "violet", "Story": "yellow", "Widely": "mint" };
const CHIP_COLORS_TEAM = {};
const CHIP_C = ["blue","coral","orange","pink","violet","mint","yellow","blue","coral","orange","pink","violet"];
TEAM_LIST.forEach((t, i) => { CHIP_COLORS_TEAM[t] = CHIP_C[i % CHIP_C.length]; });

// ==================== STATE ====================
let selectedBUs = new Set(BU_LIST);
let selectedTeams = new Set(TEAM_LIST);
let searchTerm = '';
let sortCol = 'annualCost';
let sortDir = -1;

function getFiltered() {
  return tools.filter(t =>
    selectedBUs.has(t.bu) &&
    selectedTeams.has(t.primaryTeam) &&
    (searchTerm === '' || t.name.toLowerCase().includes(searchTerm))
  );
}
function getFilteredForTable() {
  return allToolsForTable.filter(t =>
    selectedBUs.has(t.bu) &&
    (searchTerm === '' || t.name.toLowerCase().includes(searchTerm))
  );
}

// ==================== FORMAT ====================
function fmt(n) {
  return n.toLocaleString('fr-FR') + ' ‚Ç¨';
}
function fmtK(n) {
  return n >= 1000 ? (n/1000).toFixed(n >= 10000 ? 0 : 1) + 'k ‚Ç¨' : fmt(n);
}

// ==================== CHART INSTANCES ====================
let chartBU, chartTop10, chartTeam, chartBar, chartSeat;

const chartDefaults = {
  cutout: '68%',
  borderWidth: 2,
  borderColor: '#FFFFFF',
  hoverBorderWidth: 3,
  hoverOffset: 6,
};

function makeDonutOptions(showTooltipEUR) {
  return {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: '#1E1B2E',
        titleFont: { family: 'Poppins', weight: '600' },
        bodyFont: { family: 'Poppins' },
        padding: 12,
        cornerRadius: 10,
        callbacks: showTooltipEUR ? {
          label: ctx => ' ' + ctx.label + ': ' + fmt(ctx.parsed)
        } : undefined
      }
    }
  };
}

// ==================== RENDER ====================
function render() {
  const filtered = getFiltered();
  const totalCost = filtered.reduce((s, t) => s + t.annualCost, 0);
  const totalSeats = filtered.reduce((s, t) => s + t.seats, 0);
  const nbTools = filtered.length;
  const avgCost = nbTools ? Math.round(totalCost / nbTools) : 0;

  // KPIs
  document.getElementById('kpi-row').innerHTML = `
    <div class="kpi-card">
      <div class="kpi-label">Co√ªt total annuel</div>
      <div class="kpi-value">${fmtK(totalCost)}</div>
      <div class="kpi-sub">${filtered.filter(t=>t.renewal==='monthly').length} monthly${filtered.filter(t=>t.renewal==='quarterly').length ? ' / ' + filtered.filter(t=>t.renewal==='quarterly').length + ' quarterly' : ''} / ${filtered.filter(t=>t.renewal==='yearly').length} yearly</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Nombre d'outils</div>
      <div class="kpi-value">${nbTools}</div>
      <div class="kpi-sub">${BU_LIST.filter(b=>selectedBUs.has(b)).length} BU s√©lectionn√©e${BU_LIST.filter(b=>selectedBUs.has(b)).length>1?'s':''}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Total si√®ges</div>
      <div class="kpi-value">${totalSeats.toLocaleString('fr-FR')}</div>
      <div class="kpi-sub">Licences actives</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Co√ªt moyen / outil</div>
      <div class="kpi-value">${fmtK(avgCost)}</div>
      <div class="kpi-sub">par an</div>
    </div>
  `;

  // Donut BU
  const buData = BU_LIST.map(b => filtered.filter(t => t.bu === b).reduce((s, t) => s + t.annualCost, 0));
  const buColors = BU_LIST.map(b => BU_COLORS[b]);
  document.getElementById('bu-center-amount').textContent = fmtK(totalCost);

  if (chartBU) chartBU.destroy();
  chartBU = new Chart(document.getElementById('chart-bu'), {
    type: 'doughnut',
    data: { labels: BU_LIST, datasets: [{ data: buData, backgroundColor: buColors, ...chartDefaults }] },
    options: makeDonutOptions(true)
  });

  document.getElementById('legend-bu').innerHTML = BU_LIST.map((b, i) =>
    `<li><span class="legend-dot" style="background:${buColors[i]}"></span><span class="legend-name">${b}</span><span class="legend-value">${fmtK(buData[i])}</span></li>`
  ).join('');

  // Top 10
  const sorted = [...filtered].sort((a, b) => b.annualCost - a.annualCost);
  const top10 = sorted.slice(0, 10);
  const top10Labels = top10.map(t => t.name + (nbTools > 10 ? '' : ''));
  const top10Data = top10.map(t => t.annualCost);
  const top10Colors = ["#FF4F9A","#8B5CF6","#F6C026","#34D399","#3B82F6","#FF6B6B","#FB923C","#06B6D4","#A78BFA","#F472B6"];
  const top10Total = top10Data.reduce((a, b) => a + b, 0);
  document.getElementById('top10-center-amount').textContent = fmtK(top10Total);

  if (chartTop10) chartTop10.destroy();
  chartTop10 = new Chart(document.getElementById('chart-top10'), {
    type: 'doughnut',
    data: { labels: top10Labels, datasets: [{ data: top10Data, backgroundColor: top10Colors, ...chartDefaults }] },
    options: makeDonutOptions(true)
  });

  document.getElementById('legend-top10').innerHTML = top10.map((t, i) =>
    `<li><span class="legend-dot" style="background:${top10Colors[i]}"></span><span class="legend-name">${t.name} <span style="color:var(--text-light);font-weight:400;font-size:0.7rem">(${t.bu})</span></span><span class="legend-value">${fmtK(t.annualCost)}</span></li>`
  ).join('');

  // Donut Team
  const teamData = TEAM_LIST.map(tm => filtered.filter(t => t.primaryTeam === tm).reduce((s, t) => s + t.annualCost, 0)).filter((_, i) => {
    return filtered.some(t => t.primaryTeam === TEAM_LIST[i]);
  });
  const teamLabelsFiltered = TEAM_LIST.filter(tm => filtered.some(t => t.primaryTeam === tm));
  const teamColorsFiltered = teamLabelsFiltered.map(t => TEAM_COLORS[t]);
  const teamTotal = teamData.reduce((a, b) => a + b, 0);
  document.getElementById('team-center-amount').textContent = fmtK(teamTotal);

  if (chartTeam) chartTeam.destroy();
  chartTeam = new Chart(document.getElementById('chart-team'), {
    type: 'doughnut',
    data: { labels: teamLabelsFiltered, datasets: [{ data: teamData, backgroundColor: teamColorsFiltered, ...chartDefaults }] },
    options: makeDonutOptions(true)
  });

  document.getElementById('legend-team').innerHTML = teamLabelsFiltered.map((tm, i) =>
    `<li><span class="legend-dot" style="background:${teamColorsFiltered[i]}"></span><span class="legend-name">${tm}</span><span class="legend-value">${fmtK(teamData[i])}</span></li>`
  ).join('');

  // Bar chart Monthly vs Yearly per BU
  const monthlyByBU = BU_LIST.map(b => filtered.filter(t => t.bu === b && t.renewal === 'monthly').reduce((s, t) => s + t.annualCost, 0));
  const yearlyByBU = BU_LIST.map(b => filtered.filter(t => t.bu === b && t.renewal === 'yearly').reduce((s, t) => s + t.annualCost, 0));

  if (chartBar) chartBar.destroy();
  chartBar = new Chart(document.getElementById('chart-bar'), {
    type: 'bar',
    data: {
      labels: BU_LIST,
      datasets: [
        { label: 'Monthly (annualis√©)', data: monthlyByBU, backgroundColor: '#8B5CF6', borderRadius: 8 },
        { label: 'Yearly', data: yearlyByBU, backgroundColor: '#F6C026', borderRadius: 8 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top', labels: { font: { family: 'Poppins', weight: '600', size: 11 }, usePointStyle: true, pointStyle: 'rectRounded' } },
        tooltip: {
          backgroundColor: '#1E1B2E',
          titleFont: { family: 'Poppins', weight: '600' },
          bodyFont: { family: 'Poppins' },
          padding: 12, cornerRadius: 10,
          callbacks: { label: ctx => ' ' + ctx.dataset.label + ': ' + fmt(ctx.parsed.y) }
        }
      },
      scales: {
        y: { beginAtZero: true, grid: { color: '#F3F0F7' }, ticks: { font: { family: 'Poppins', size: 11 }, callback: v => fmtK(v) } },
        x: { grid: { display: false }, ticks: { font: { family: 'Poppins', weight: '600', size: 11 } } }
      }
    }
  });

  // Seat cost chart
  const seatCostByBU = BU_LIST.map(b => {
    const buTools = filtered.filter(t => t.bu === b && t.seats > 1);
    const totalC = buTools.reduce((s, t) => s + t.annualCost, 0);
    const totalS = buTools.reduce((s, t) => s + t.seats, 0);
    return totalS ? Math.round(totalC / totalS) : 0;
  });

  if (chartSeat) chartSeat.destroy();
  chartSeat = new Chart(document.getElementById('chart-seat'), {
    type: 'bar',
    data: {
      labels: BU_LIST,
      datasets: [{ label: '‚Ç¨ / si√®ge / an', data: seatCostByBU, backgroundColor: BU_LIST.map(b => BU_COLORS[b]), borderRadius: 8 }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1E1B2E',
          titleFont: { family: 'Poppins', weight: '600' },
          bodyFont: { family: 'Poppins' },
          padding: 12, cornerRadius: 10,
          callbacks: { label: ctx => ' ' + fmt(ctx.parsed.x) + ' / si√®ge / an' }
        }
      },
      scales: {
        x: { beginAtZero: true, grid: { color: '#F3F0F7' }, ticks: { font: { family: 'Poppins', size: 11 }, callback: v => v + ' ‚Ç¨' } },
        y: { grid: { display: false }, ticks: { font: { family: 'Poppins', weight: '600', size: 11 } } }
      }
    }
  });

  // Table
  const BU_TAG_CLASS = { "MS group": "bu-ms", "Farly": "bu-farly", "Story": "bu-story", "Widely": "bu-widely" };
  const tableData = getFilteredForTable();
  const tableSorted = [...tableData].sort((a, b) => {
    let va = a[sortCol], vb = b[sortCol];
    if (typeof va === 'string') va = va.toLowerCase();
    if (typeof vb === 'string') vb = vb.toLowerCase();
    return va < vb ? -sortDir : va > vb ? sortDir : 0;
  });

  document.getElementById('table-body').innerHTML = tableSorted.map(t => {
    const isExcluded = t.excluded || t.price === 0;
    const rowStyle = isExcluded ? 'opacity:0.45;' : '';
    const costDisplay = isExcluded ? (t.note || 'NC') : fmt(t.annualCost);
    const priceDisplay = t.price > 0 ? t.price.toLocaleString('fr-FR') + ' ' + (t.currency === 'USD' ? '$' : '‚Ç¨') : (t.note || 'NC');
    return `<tr style="${rowStyle}">
      <td style="font-weight:600">${t.name}${t.note && !isExcluded ? ' <span style="font-size:0.65rem;color:var(--text-light)" title="'+t.note+'">‚ÑπÔ∏è</span>' : ''}</td>
      <td>${t.team}</td>
      <td><span class="bu-tag ${BU_TAG_CLASS[t.bu]}">${t.bu}</span></td>
      <td>${t.renewal}</td>
      <td>${t.seats || 'NC'}</td>
      <td>${priceDisplay}</td>
      <td style="font-weight:700">${costDisplay}</td>
      <td style="font-size:0.72rem">${t.admin ? '<a href="mailto:'+t.admin+'" style="color:var(--violet);text-decoration:none" title="'+t.admin+'">'+t.admin.split('@')[0]+'</a>' : ''}</td>
      <td>${t.url ? '<a href="'+t.url+'" target="_blank" rel="noopener" style="color:var(--blue);text-decoration:none;font-size:0.75rem" title="'+t.url+'">Ouvrir</a>' : ''}</td>
    </tr>`;
  }).join('');

  // Sort indicators
  document.querySelectorAll('thead th').forEach(th => {
    th.classList.toggle('sorted', th.dataset.sort === sortCol);
    const arrow = th.querySelector('.sort-arrow');
    if (arrow) arrow.textContent = th.dataset.sort === sortCol ? (sortDir === 1 ? '‚Üë' : '‚Üì') : '‚Üï';
  });
}

// ==================== CHIPS ====================
function renderChips() {
  const buChips = document.getElementById('bu-chips');
  buChips.innerHTML = `<button class="chip ${selectedBUs.size === BU_LIST.length ? 'active' : ''}" data-color="all" data-bu="__all__">Toutes</button>` +
    BU_LIST.map(b => `<button class="chip ${selectedBUs.has(b) ? 'active' : ''}" data-color="${CHIP_COLORS_BU[b]}" data-bu="${b}">${b}</button>`).join('');

  const teamChips = document.getElementById('team-chips');
  teamChips.innerHTML = `<button class="chip ${selectedTeams.size === TEAM_LIST.length ? 'active' : ''}" data-color="all" data-team="__all__">Toutes</button>` +
    TEAM_LIST.map(t => `<button class="chip ${selectedTeams.has(t) ? 'active' : ''}" data-color="${CHIP_COLORS_TEAM[t]}" data-team="${t}">${t}</button>`).join('');
}

document.getElementById('bu-chips').addEventListener('click', e => {
  const btn = e.target.closest('.chip');
  if (!btn) return;
  const bu = btn.dataset.bu;
  if (bu === '__all__') {
    selectedBUs = new Set(BU_LIST);
  } else {
    if (selectedBUs.size === BU_LIST.length) {
      selectedBUs = new Set([bu]);
    } else if (selectedBUs.has(bu)) {
      selectedBUs.delete(bu);
      if (selectedBUs.size === 0) selectedBUs = new Set(BU_LIST);
    } else {
      selectedBUs.add(bu);
    }
  }
  renderChips();
  render();
});

document.getElementById('team-chips').addEventListener('click', e => {
  const btn = e.target.closest('.chip');
  if (!btn) return;
  const team = btn.dataset.team;
  if (team === '__all__') {
    selectedTeams = new Set(TEAM_LIST);
  } else {
    if (selectedTeams.size === TEAM_LIST.length) {
      selectedTeams = new Set([team]);
    } else if (selectedTeams.has(team)) {
      selectedTeams.delete(team);
      if (selectedTeams.size === 0) selectedTeams = new Set(TEAM_LIST);
    } else {
      selectedTeams.add(team);
    }
  }
  renderChips();
  render();
});

document.getElementById('reset-filters').addEventListener('click', () => {
  selectedBUs = new Set(BU_LIST);
  selectedTeams = new Set(TEAM_LIST);
  searchTerm = '';
  document.getElementById('search').value = '';
  renderChips();
  render();
});

// Search
document.getElementById('search').addEventListener('input', e => {
  searchTerm = e.target.value.toLowerCase();
  render();
});

// Table sort
document.querySelector('thead').addEventListener('click', e => {
  const th = e.target.closest('th');
  if (!th || !th.dataset.sort) return;
  if (sortCol === th.dataset.sort) {
    sortDir *= -1;
  } else {
    sortCol = th.dataset.sort;
    sortDir = th.dataset.sort === 'annualCost' || th.dataset.sort === 'seats' || th.dataset.sort === 'pricePerSeat' ? -1 : 1;
  }
  render();
});

// ==================== ALTERNATIVES ====================
// Cross-referenced with existing stack to suggest smart consolidations
const ALTERNATIVES = {
  "Miro": {
    verdict: "Challenger le renouvellement",
    reason: "Figma (d√©j√† pay√© chez Story + MS group) inclut FigJam, qui couvre 90% des usages whiteboard/collab.",
    alts: [
      { name: "FigJam", tag: "d√©j√† dans le stack", saving: "Inclus dans les licences Figma existantes ‚Äî 0 ‚Ç¨ suppl√©mentaire" },
    ]
  },
  "Pitch": {
    verdict: "Arr√™t recommand√©",
    reason: "82 si√®ges pour un outil de pr√©sentation alors que Google Slides (Workspace) et Notion (d√©j√† pay√©s) couvrent ce besoin. Sharepoint est aussi disponible chez Widely.",
    alts: [
      { name: "Google Slides", tag: "d√©j√† dans le stack", saving: "Gratuit ‚Äî d√©j√† inclus dans Google Workspace" },
      { name: "Notion", tag: "d√©j√† dans le stack", saving: "D√©j√† pay√© ‚Äî 174 si√®ges, supporte les pr√©sentations" },
    ]
  },
  "Social Insider": {
    verdict: "Benchmarker avant renouvellement",
    reason: "3 500 $/an pour 5 si√®ges. Des alternatives matures existent √† moindre co√ªt pour le social listening.",
    alts: [
      { name: "Metricool", tag: "alternative", saving: "~40% moins cher ‚Äî couvre benchmark + scheduling" },
      { name: "Supermetrics", tag: "d√©j√† dans le stack", saving: "D√©j√† pay√© chez Story ‚Äî peut couvrir une partie du reporting social" },
    ]
  },
  "Supermetrics": {
    verdict: "Challenger le p√©rim√®tre",
    reason: "1 596 ‚Ç¨/an pour 3 si√®ges. V√©rifier si les connecteurs natifs Looker Studio / Google Sheets ne suffisent pas pour les dashboards.",
    alts: [
      { name: "Connecteurs natifs Google", tag: "gratuit", saving: "Gratuit ‚Äî Looker Studio a des connecteurs Meta, Google Ads, etc." },
      { name: "Funnel.io", tag: "alternative", saving: "√Ä benchmarker ‚Äî plus scalable si beaucoup de sources" },
    ]
  },
  "Filestage": {
    verdict: "Challenger le nombre de si√®ges",
    reason: "47 si√®ges √† 158 ‚Ç¨/an. V√©rifier les si√®ges r√©ellement actifs. Frame.io (int√©gr√© Adobe) pourrait √™tre une option vu la licence Adobe chez Story.",
    alts: [
      { name: "Frame.io", tag: "synergy Adobe", saving: "Inclus dans certaines licences Adobe ‚Äî d√©j√† pay√© chez Story" },
      { name: "Notion", tag: "d√©j√† dans le stack", saving: "Proofing basique possible via commentaires ‚Äî d√©j√† pay√©" },
    ]
  },
  "Signaturit": {
    verdict: "Mutualiser avec Farly",
    reason: "330 ‚Ç¨/an pour 3 si√®ges. Docusign est d√©j√† pay√© chez Farly ‚Äî possibilit√© de mutualiser les licences cross-BU.",
    alts: [
      { name: "Docusign", tag: "d√©j√† dans le stack", saving: "D√©j√† pay√© chez Farly ‚Äî mutualiser cross-BU" },
      { name: "Yousign", tag: "alternative", saving: "~40% moins cher ‚Äî solution fran√ßaise, conforme eIDAS" },
    ]
  },
  "Pandadoc": {
    verdict: "Mutualiser avec Farly",
    reason: "1 868 $/an chez Widely. Docusign est d√©j√† pay√© chez Farly ‚Äî possibilit√© de mutualiser.",
    alts: [
      { name: "Docusign", tag: "d√©j√† dans le stack", saving: "D√©j√† pay√© chez Farly ‚Äî mutualiser la licence" },
      { name: "Yousign", tag: "alternative", saving: "~50% moins cher si Docusign ne convient pas" },
    ]
  },
  "iStock": {
    verdict: "Mutualiser avec Adobe Stock",
    reason: "1 759 ‚Ç¨/mois (21k‚Ç¨/an). Adobe est d√©j√† pay√© chez Story ‚Äî Adobe Stock pourrait √™tre inclus ou n√©goci√© en bundle.",
    alts: [
      { name: "Adobe Stock", tag: "synergy Adobe", saving: "N√©gociable en bundle avec la licence Adobe entreprise existante" },
      { name: "Unsplash / Pexels", tag: "gratuit", saving: "Gratuit pour de nombreux usages √©ditoriaux" },
    ]
  },
  "Overlord 2": {
    verdict: "Faible enjeu ‚Äî valider l'usage",
    reason: "177 ‚Ç¨/an pour 3 si√®ges. Co√ªt marginal mais v√©rifier si les 3 licences sont bien utilis√©es.",
    alts: []
  },
  "Artlist": {
    verdict: "V√©rifier le besoin",
    reason: "575 ‚Ç¨/an pour 1 si√®ge. Envato (d√©j√† pay√©) couvre aussi musique/SFX ‚Äî possibilit√© de doublon partiel.",
    alts: [
      { name: "Envato / Envato Elements", tag: "d√©j√† dans le stack", saving: "D√©j√† pay√© ‚Äî couvre musique, vid√©o, templates" },
      { name: "Epidemic Sound", tag: "alternative", saving: "Alternative comp√©titive pour la musique libre de droits" },
    ]
  },
};

// ==================== RENEWAL ALERTS ====================
function renderAlerts() {
  const today = new Date('2026-02-17');
  const in60 = new Date(today);
  in60.setDate(in60.getDate() + 60);

  // Find tools with renewal dates within 60 days or already passed (within last 60 days)
  const past60 = new Date(today);
  past60.setDate(past60.getDate() - 60);

  const alertTools = rawTools
    .filter(t => !t.excluded && t.renewalDate && t.renewal === 'yearly')
    .map(t => {
      const rd = new Date(t.renewalDate);
      const diffMs = rd - today;
      const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));
      return { ...t, renewalDateObj: rd, daysUntil: diffDays, annualCost: computeAnnualCostEUR(t) };
    })
    .filter(t => t.daysUntil <= 60 && t.daysUntil >= -60)
    .sort((a, b) => a.daysUntil - b.daysUntil);

  const section = document.getElementById('alert-section');
  const container = document.getElementById('alert-cards');

  if (alertTools.length === 0) {
    section.style.display = 'none';
    return;
  }

  section.style.display = 'block';

  container.innerHTML = alertTools.map(t => {
    let badgeClass, badgeText;
    if (t.daysUntil < 0) {
      badgeClass = 'overdue';
      badgeText = `Renouvel√© il y a ${Math.abs(t.daysUntil)} jour${Math.abs(t.daysUntil) > 1 ? 's' : ''} ‚Äî √† challenger`;
    } else if (t.daysUntil === 0) {
      badgeClass = 'urgent';
      badgeText = "Renouvellement aujourd'hui !";
    } else if (t.daysUntil <= 15) {
      badgeClass = 'urgent';
      badgeText = `Renouvellement dans ${t.daysUntil} jour${t.daysUntil > 1 ? 's' : ''}`;
    } else if (t.daysUntil <= 30) {
      badgeClass = 'warning';
      badgeText = `Renouvellement dans ${t.daysUntil} jours`;
    } else {
      badgeClass = 'soon';
      badgeText = `Renouvellement dans ${t.daysUntil} jours`;
    }

    const dateStr = t.renewalDateObj.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
    const info = ALTERNATIVES[t.name];
    const tagClass = tag => tag === 'd√©j√† dans le stack' ? 'stack' : tag === 'gratuit' ? 'free' : tag.startsWith('synergy') ? 'synergy' : 'alternative';

    let analysisHTML = '';
    if (info) {
      const verdictHTML = info.verdict ? `<span class="alert-verdict">${info.verdict}</span>` : '';
      const reasonHTML = info.reason ? `<div class="alert-reason">${info.reason}</div>` : '';
      const altsHTML = info.alts && info.alts.length > 0 ? `
        <div class="alt-label">Alternatives identifi√©es</div>
        <div class="alt-list">
          ${info.alts.map(a => `<div class="alt-item"><span class="alt-tag ${tagClass(a.tag)}">${a.tag}</span><span class="alt-item-name">${a.name}</span><span class="alt-item-detail">${a.saving}</span></div>`).join('')}
        </div>
      ` : '';
      analysisHTML = verdictHTML + reasonHTML + altsHTML;
    }

    return `
      <div class="alert-card">
        <span class="countdown-badge ${badgeClass}">${badgeText}</span>
        <div class="alert-card-header">
          <div class="tool-info">
            <div class="tool-name">${t.name}</div>
            <div class="tool-meta">${t.bu} ¬∑ ${t.team.split(',')[0].trim()} ¬∑ ${dateStr}</div>
            <div class="tool-meta">${t.admin ? 'üë§ <a href="mailto:'+t.admin+'" style="color:var(--violet);text-decoration:none">'+t.admin+'</a>' : ''}${t.url ? ' ¬∑ <a href="'+t.url+'" target="_blank" rel="noopener" style="color:var(--blue);text-decoration:none">G√©rer l\'abo</a>' : ''}</div>
          </div>
          <div class="tool-cost">${fmt(t.annualCost)}/an</div>
        </div>
        ${analysisHTML}
      </div>
    `;
  }).join('');
}

// ==================== INIT ====================
renderChips();
render();
renderAlerts();
</script>
</body>
</html>
